<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Leaderboard - Splay Tree Game</title>
    <!-- Firebase SDKs (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-analytics-compat.js"></script>
    <style>
        /* Inline CSS */

        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 0;
            padding: 20px;
            background-color: #f8f9fa;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 {
            margin-bottom: 20px;
        }

        #backNav {
            margin-bottom: 20px;
        }

        #backNav a {
            text-decoration: none;
            color: #007BFF;
            font-weight: bold;
            font-size: 1.1em;
        }

        #backNav a:hover {
            color: #0056b3;
        }

        /* Leaderboard Section */
        #leaderboardSection {
            margin-top: 20px;
            width: 100%;
            max-width: 800px;
        }

        #leaderboardSection h2 {
            margin-bottom: 10px;
        }

        #leaderboard {
            width: 100%;
            border-collapse: collapse;
        }

        #leaderboard th,
        #leaderboard td {
            border: 1px solid #dee2e6;
            padding: 10px;
            text-align: center;
        }

        #leaderboard th {
            background-color: #343a40;
            color: #fff;
        }

        #leaderboard tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            #leaderboardSection {
                max-width: 100%;
            }
        }

        /* Loading Spinner */
        #loading {
            margin-top: 20px;
            font-size: 1.2em;
            color: #007BFF;
        }
    </style>
</head>

<body>
    <h1>Leaderboard</h1>

    <!-- Navigation Back to Game -->
    <div id="backNav">
        <a href="index.html">‚Üê Back to Game</a>
    </div>

    <!-- Loading Indicator -->
    <div id="loading">Loading leaderboard...</div>

    <!-- Leaderboard Section -->
    <div id="leaderboardSection">
        <h2>Top 10 Scores</h2>
        <table id="leaderboard">
            <thead>
                <tr>
                    <th>Rank</th>
                    <th>Username</th>
                    <th>Score</th>
                    <th>Date</th>
                </tr>
            </thead>
            <tbody>
                <!-- Leaderboard entries will be populated here -->
            </tbody>
        </table>
    </div>

    <!-- Firebase Initialization and Scripts -->
    <!-- Load Firebase config from external file (gitignored) -->
    <script src="config.js"></script>
    <script>
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        firebase.analytics();

        // Initialize Firestore
        const db = firebase.firestore();
        console.log("Firestore initialized on Leaderboard page:", db);

        // Function to load the leaderboard in real-time
        function loadLeaderboardRealtime() {
            console.log('Setting up real-time leaderboard listener...');
            const leaderboardBody = document
                .getElementById('leaderboard')
                .getElementsByTagName('tbody')[0];
            const loadingIndicator = document.getElementById('loading');

            if (!leaderboardBody) {
                console.error('Leaderboard <tbody> element not found.');
                loadingIndicator.innerText = 'Error loading leaderboard.';
                return;
            }

            // Set up real-time listener
            db.collection('leaderboard')
                .orderBy('score', 'desc')
                .orderBy('lastUpdated', 'asc')
                .limit(10)
                .onSnapshot((querySnapshot) => {
                    leaderboardBody.innerHTML = ''; // Clear existing entries
                    let rank = 1;

                    if (querySnapshot.empty) {
                        console.log('No leaderboard data found.');
                        const row = leaderboardBody.insertRow();
                        const cell = row.insertCell(0);
                        cell.colSpan = 4;
                        cell.innerText = 'No data available.';
                        cell.style.color = '#dc3545';
                        loadingIndicator.style.display = 'none';
                        return;
                    }

                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        console.log('Leaderboard doc:', doc.id, data);

                        // Validate data fields
                        if (!data.username || typeof data.score !== 'number') {
                            console.warn(`Invalid data in document ${doc.id}:`, data);
                            return; // Skip invalid entries
                        }

                        const date = data.lastUpdated
                            ? data.lastUpdated.toDate().toLocaleString()
                            : 'N/A';
                        const row = leaderboardBody.insertRow();
                        row.insertCell(0).innerText = rank;
                        row.insertCell(1).innerText = data.username;
                        row.insertCell(2).innerText = data.score;
                        row.insertCell(3).innerText = date;
                        rank++;
                    });
                    console.log('Leaderboard updated with', querySnapshot.size, 'entries.');
                    loadingIndicator.style.display = 'none';
                }, (error) => {
                    console.error('Error fetching leaderboard: ', error);
                    const leaderboardBody = document
                        .getElementById('leaderboard')
                        .getElementsByTagName('tbody')[0];
                    leaderboardBody.innerHTML = ''; // Clear existing entries
                    const row = leaderboardBody.insertRow();
                    const cell = row.insertCell(0);
                    cell.colSpan = 4;
                    cell.innerText = 'Error loading leaderboard data.';
                    cell.style.color = '#dc3545';
                    loadingIndicator.innerText = 'Error loading leaderboard.';
                });
        }

        // Initialize Leaderboard
        document.addEventListener('DOMContentLoaded', () => {
            loadLeaderboardRealtime();
        });
    </script>
</body>

</html>
