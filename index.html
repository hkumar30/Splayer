<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Splayer</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/roughjs@4.6.6/bundled/rough.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-analytics-compat.js"></script>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<!-- ═══ START SCREEN ═══ -->
<div id="startScreen" class="screen active">
  <div class="notebook-card" style="margin-top:8vh">
    <h1 class="start-title">Splayer</h1>
    <canvas id="startTreeCanvas"></canvas>
    <div class="start-name">
      <label for="playerName">Your name</label>
      <input type="text" id="playerName" class="notebook-line-input" placeholder="write here..." autocomplete="off">
    </div>
    <button id="newGameBtn" class="cartoon-btn big">New Game</button>
    <br>
    <a href="leaderboard.html" class="start-link">Leaderboard</a>
  </div>
</div>

<!-- ═══ GAME SCREEN ═══ -->
<div id="gameScreen" class="screen">
  <header class="game-header">
    <button id="homeBtn" class="header-home">Splayer</button>
    <div class="level-info">
      <span>Level <span id="levelNum">1</span> / <span id="totalLevels">3</span></span>
      <div class="level-dots" id="levelDots"></div>
    </div>
    <div class="score-badge">Score: <span id="scoreValue">0</span></div>
  </header>

  <div class="game-main">
    <div id="refThumb" class="ref-thumb">
      <div class="ref-label">Target</div>
      <canvas id="refCanvasSmall"></canvas>
    </div>
    <div class="player-canvas-wrap">
      <canvas id="playerCanvas"></canvas>
    </div>
  </div>

  <div id="feedback" class="scribble-feedback"></div>

  <div class="controls">
    <input type="number" id="nodeValue" step="1" placeholder="value" class="node-input">
    <div class="btn-group">
      <button id="insertBtn" class="cartoon-btn">Insert</button>
      <button id="searchBtn" class="cartoon-btn">Search</button>
      <button id="deleteBtn" class="cartoon-btn">Delete</button>
    </div>
    <div class="btn-group">
      <button id="resetBtn" class="cartoon-btn secondary">Reset</button>
      <button id="nextLevelBtn" class="cartoon-btn accent" disabled>Next Level</button>
    </div>
  </div>

  <!-- Lightbox for enlarged reference tree -->
  <div id="refLightbox" class="lightbox">
    <div class="lightbox-overlay" id="lightboxOverlay"></div>
    <div class="lightbox-panel">
      <div class="lightbox-head">
        <span>Target Tree</span>
        <button id="lightboxClose" class="lightbox-x">&times;</button>
      </div>
      <canvas id="refCanvasLarge"></canvas>
    </div>
  </div>
</div>

<!-- ═══ WIN SCREEN ═══ -->
<div id="winScreen" class="screen">
  <div class="notebook-card" style="margin-top:12vh">
    <div class="win-stars"><span>&#9733;</span> <span>&#9733;</span> <span>&#9733;</span></div>
    <h1 class="win-title">You Win!</h1>
    <div class="win-score">Total Score: <span id="finalScore">0</span></div>
    <div class="win-actions">
      <button id="playAgainBtn" class="cartoon-btn">Play Again</button>
      <button id="viewLbBtn" class="cartoon-btn accent">Leaderboard</button>
      <button id="returnHomeBtn" class="cartoon-btn secondary">Home</button>
    </div>
  </div>
</div>

<!-- ═══ Scripts ═══ -->
<script src="config.js"></script>
<script>
  firebase.initializeApp(firebaseConfig);
  firebase.analytics();
  var db = firebase.firestore();
</script>
<script src="script.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {

  /* ── Levels (add more objects to extend the game) ─── */
  const levels = [
    { keys: [10, 20, 30, 40, 50] },
    { keys: [15, 25, 35, 45, 55, 65] },
    { keys: [5, 3, 8, 1, 4, 7, 10] },
  ];

  /* ── State ─── */
  let playerName   = '';
  let currentLevel  = 0;
  let currentScore  = 0;
  let totalScore    = 0;
  let splayTree     = new SplayTree();
  let referenceTree = new SplayTree();

  /* ── Renderers ─── */
  const playerRenderer   = new TreeRenderer(document.getElementById('playerCanvas'), {
    nodeFill: '#aa6f73', textColor: '#fff',
  });
  const refSmallRenderer = new TreeRenderer(document.getElementById('refCanvasSmall'), {
    nodeFill: '#eea990', textColor: '#66545e', showPaper: false, padding: 30, nodeRadius: 16, roughness: 1.2,
  });
  const refLargeRenderer = new TreeRenderer(document.getElementById('refCanvasLarge'), {
    nodeFill: '#eea990', textColor: '#66545e',
  });

  /* ── Screens ─── */
  function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
  }

  /* ── Rendering ─── */
  function renderPlayer()  { playerRenderer.render(splayTree.root); }
  function renderRef() {
    refSmallRenderer.render(referenceTree.root);
    if (document.getElementById('refLightbox').classList.contains('active')) {
      refLargeRenderer.render(referenceTree.root);
    }
  }

  /* ── Score ─── */
  function updateScore(pts) {
    currentScore = Math.max(0, currentScore + pts);
    document.getElementById('scoreValue').textContent = currentScore;
  }

  /* ── Feedback ─── */
  function setFeedback(msg, ok) {
    const el = document.getElementById('feedback');
    el.textContent = msg;
    el.className = 'scribble-feedback' + (ok ? ' success' : '');
  }

  /* ── Controls ─── */
  function setControls(on) {
    ['insertBtn','searchBtn','deleteBtn'].forEach(id => {
      document.getElementById(id).disabled = !on;
    });
  }

  /* ── Level dots ─── */
  function updateDots() {
    const c = document.getElementById('levelDots');
    c.innerHTML = '';
    for (let i = 0; i < levels.length; i++) {
      const d = document.createElement('span');
      d.className = 'dot' + (i <= currentLevel ? ' filled' : '');
      c.appendChild(d);
    }
  }

  /* ── Load level ─── */
  function loadLevel(lvl) {
    splayTree     = new SplayTree();
    referenceTree = new SplayTree();
    levels[lvl].keys.forEach(k => referenceTree.insert(k));

    currentScore = 0;
    document.getElementById('scoreValue').textContent = '0';
    document.getElementById('levelNum').textContent = lvl + 1;
    document.getElementById('totalLevels').textContent = levels.length;
    updateDots();
    setFeedback('');
    setControls(true);
    document.getElementById('nextLevelBtn').disabled = true;
    document.getElementById('nodeValue').value = '';

    renderPlayer();
    renderRef();
  }

  /* ── Tree comparison ─── */
  function treesMatch(a, b) {
    if (!a && !b) return true;
    if (!a || !b) return false;
    if (a.key !== b.key) return false;
    return treesMatch(a.left, b.left) && treesMatch(a.right, b.right);
  }

  function checkMatch() {
    if (treesMatch(splayTree.root, referenceTree.root)) {
      setFeedback('Trees match! Great job!', true);
      updateScore(50);
      submitScore();
      document.getElementById('nextLevelBtn').disabled = false;
      setControls(false);
    } else {
      setFeedback('~ Keep going! Match the target tree ~');
      document.getElementById('nextLevelBtn').disabled = true;
    }
  }

  /* ── Firebase helpers ─── */
  function getPlayerId() {
    let id = localStorage.getItem('splayer_playerId');
    if (!id) {
      id = 'p_' + Date.now() + '_' + Math.random().toString(36).slice(2, 12);
      localStorage.setItem('splayer_playerId', id);
    }
    return id;
  }

  function submitScore() {
    if (!playerName) return;
    db.collection('leaderboard').doc(getPlayerId()).set({
      username: playerName,
      score: firebase.firestore.FieldValue.increment(currentScore),
      lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
    }, { merge: true }).catch(e => console.error('Submit error', e));
  }

  /* ── Value helper ─── */
  function readValue() {
    const raw = document.getElementById('nodeValue').value.trim();
    if (!/^-?\d+$/.test(raw)) return null;
    return parseInt(raw, 10);
  }

  function flashHighlight(renderer, tree, key) {
    renderer.highlight(key);
    renderer.render(tree.root);
    setTimeout(() => { renderer.clearHighlight(); renderer.render(tree.root); }, 600);
  }

  /* ── Button handlers ─── */
  document.getElementById('insertBtn').addEventListener('click', () => {
    const v = readValue();
    if (v === null) { updateScore(-5); setFeedback('Enter a valid integer!'); return; }
    const ok = splayTree.insert(v);
    renderPlayer();
    flashHighlight(playerRenderer, splayTree, v);
    if (ok) { updateScore(10); } else { updateScore(-5); setFeedback('Already in tree!'); }
    checkMatch();
    document.getElementById('nodeValue').value = '';
  });

  document.getElementById('searchBtn').addEventListener('click', () => {
    const v = readValue();
    if (v === null) { updateScore(-5); setFeedback('Enter a valid integer!'); return; }
    const found = splayTree.search(v);
    renderPlayer();
    flashHighlight(playerRenderer, splayTree, v);
    if (found) { updateScore(5); } else { updateScore(-5); setFeedback('Key not found!'); }
    checkMatch();
    document.getElementById('nodeValue').value = '';
  });

  document.getElementById('deleteBtn').addEventListener('click', () => {
    const v = readValue();
    if (v === null) { updateScore(-5); setFeedback('Enter a valid integer!'); return; }
    const ok = splayTree.delete(v);
    renderPlayer();
    if (ok) { updateScore(15); } else { updateScore(-5); setFeedback('Key not found!'); }
    checkMatch();
    document.getElementById('nodeValue').value = '';
  });

  document.getElementById('resetBtn').addEventListener('click', () => {
    splayTree = new SplayTree();
    currentScore = 0;
    document.getElementById('scoreValue').textContent = '0';
    renderPlayer();
    setFeedback('');
    setControls(true);
    document.getElementById('nextLevelBtn').disabled = true;
  });

  document.getElementById('nextLevelBtn').addEventListener('click', () => {
    totalScore += currentScore;
    currentLevel++;
    if (currentLevel >= levels.length) {
      document.getElementById('finalScore').textContent = totalScore;
      showScreen('winScreen');
      return;
    }
    loadLevel(currentLevel);
  });

  /* ── Start screen ─── */
  const savedName = localStorage.getItem('splayer_playerName');
  if (savedName) document.getElementById('playerName').value = savedName;

  document.getElementById('newGameBtn').addEventListener('click', () => {
    const inp = document.getElementById('playerName');
    playerName = inp.value.trim();
    if (!playerName) {
      inp.classList.add('shake');
      setTimeout(() => inp.classList.remove('shake'), 400);
      inp.focus();
      return;
    }
    localStorage.setItem('splayer_playerName', playerName);
    currentLevel = 0;
    totalScore   = 0;
    showScreen('gameScreen');
    loadLevel(0);
  });

  /* ── Lightbox ─── */
  document.getElementById('refThumb').addEventListener('click', () => {
    document.getElementById('refLightbox').classList.add('active');
    refLargeRenderer.render(referenceTree.root);
  });
  document.getElementById('lightboxClose').addEventListener('click', () => {
    document.getElementById('refLightbox').classList.remove('active');
  });
  document.getElementById('lightboxOverlay').addEventListener('click', () => {
    document.getElementById('refLightbox').classList.remove('active');
  });

  /* ── Win screen buttons ─── */
  document.getElementById('playAgainBtn').addEventListener('click', () => {
    currentLevel = 0;
    totalScore   = 0;
    showScreen('gameScreen');
    loadLevel(0);
  });
  document.getElementById('viewLbBtn').addEventListener('click', () => {
    window.location.href = 'leaderboard.html';
  });
  document.getElementById('returnHomeBtn').addEventListener('click', () => {
    showScreen('startScreen');
    drawStartDoodle();
  });

  /* ── Home button in game header ─── */
  document.getElementById('homeBtn').addEventListener('click', () => {
    if (!confirm('Leave the game? Progress on this level will be lost.')) return;
    showScreen('startScreen');
    drawStartDoodle();
  });

  /* ── Resize ─── */
  window.addEventListener('resize', () => {
    renderPlayer();
    renderRef();
  });

  /* ── Start-screen doodle tree (spells S-P-L-A-Y-E-R in level-order) ─── */
  function drawStartDoodle() {
    const canvas = document.getElementById('startTreeCanvas');
    const dpr = window.devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();
    if (rect.width < 1) return;
    canvas.width  = rect.width  * dpr;
    canvas.height = rect.height * dpr;
    const ctx = canvas.getContext('2d');
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

    const rc = rough.canvas(canvas);
    const w = rect.width, h = rect.height, cx = w / 2;

    const nodes = [
      { x: cx,       y: 32,  c: '#aa6f73', l: 'S' },
      { x: cx - 80,  y: 95,  c: '#eea990', l: 'P' },
      { x: cx + 80,  y: 95,  c: '#eea990', l: 'L' },
      { x: cx - 115, y: 158, c: '#f6e0b5', l: 'A' },
      { x: cx - 45,  y: 158, c: '#f6e0b5', l: 'Y' },
      { x: cx + 45,  y: 158, c: '#f6e0b5', l: 'E' },
      { x: cx + 115, y: 158, c: '#f6e0b5', l: 'R' },
    ];
    const edges = [[0,1],[0,2],[1,3],[1,4],[2,5],[2,6]];

    for (const [i, j] of edges) {
      rc.line(nodes[i].x, nodes[i].y, nodes[j].x, nodes[j].y, {
        stroke: '#66545e', strokeWidth: 2, roughness: 2.2,
      });
    }
    for (const n of nodes) {
      rc.circle(n.x, n.y, 38, {
        fill: n.c, fillStyle: 'solid', stroke: '#66545e', strokeWidth: 2, roughness: 1.6,
      });
      ctx.save();
      ctx.font = 'bold 15px "Patrick Hand",cursive';
      ctx.fillStyle = n.c === '#f6e0b5' ? '#66545e' : '#fff';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(n.l, n.x, n.y + 1);
      ctx.restore();
    }
  }

  document.fonts.ready.then(() => {
    drawStartDoodle();
    setTimeout(drawStartDoodle, 300);
  });
});
</script>
</body>
</html>
