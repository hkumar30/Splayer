<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Splay Tree Game</title>
    <!-- Cytoscape.js -->
    <script src="https://unpkg.com/cytoscape@3.30.4/dist/cytoscape.min.js"></script>
    <!-- Firebase SDKs (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-analytics-compat.js"></script>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <h1>Splay Tree Game</h1>

    <!-- Username Section -->
    <div id="usernameSection">
        <input type="text" id="username" placeholder="Enter your name" />
    </div>

    <!-- Controls Section -->
    <div id="controls">
        <input
            type="number"
            id="nodeValue"
            placeholder="Node Value"
            step="1"
        />
        <button id="insertBtn">Insert</button>
        <button id="searchBtn">Search</button>
        <button id="deleteBtn">Delete</button>
        <button id="resetBtn">Reset Player Tree</button>
        <button id="nextLevelBtn" disabled>Next Level</button> <!-- Disabled by default -->
    </div>

    <!-- Feedback and Score Sections -->
    <div id="feedback"></div>
    <div id="score">Score: 0</div>

    <!-- Trees Container -->
    <div id="treesContainer">
        <!-- Reference Tree -->
        <div class="treeSection">
            <h2>Reference Tree</h2>
            <div id="referenceCy"></div>
        </div>

        <!-- Player's Tree -->
        <div class="treeSection">
            <h2>Your Tree</h2>
            <div id="cy"></div>
        </div>
    </div>

    <!-- Navigation to Leaderboard -->
    <div id="nav">
        <a href="leaderboard.html">View Leaderboard</a>
    </div>

    <!-- Firebase Initialization and Scripts -->
    <script src="config.js"></script>
    <script>
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        firebase.analytics();

        // Initialize Firestore
        var db = firebase.firestore();
        console.log("Firestore initialized:", db);
    </script>

    <script src="script.js"></script>
    <script>
        // Main script
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM fully loaded and parsed.');

            if (typeof SplayTree === 'undefined') {
                console.error('SplayTree class is not defined.');
                return;
            }

            let splayTree = new SplayTree();
            let referenceTree = new SplayTree();
            let currentLevel = 0;
            let currentScore = 0; // Numerical score
            let username = '';

            const levels = [
                [10, 20, 30, 40, 50],
                [15, 25, 35, 45, 55, 65],
                [5, 3, 8, 1, 4, 7, 10],
                // Add more levels as needed
            ];

            // Keep username in sync with input (so it's current even without blur)
            const usernameInput = document.getElementById('username');
            usernameInput.addEventListener('input', () => { username = usernameInput.value.trim(); });
            usernameInput.addEventListener('change', () => { username = usernameInput.value.trim(); });

            // Initialize Cytoscape for Player's Tree
            let cy = cytoscape({
                container: document.getElementById('cy'),
                style: [
                    {
                        selector: 'node',
                        style: {
                            'content': 'data(label)',
                            'text-valign': 'center',
                            'color': '#fff',
                            'background-color': '#007BFF',
                            'width': '50px',
                            'height': '50px',
                            'font-size': '14px',
                            'border-width': 2,
                            'border-color': '#fff'
                        }
                    },
                    {
                        selector: 'edge',
                        style: {
                            'width': 3,
                            'line-color': '#ccc',
                            'target-arrow-color': '#ccc',
                            'target-arrow-shape': 'triangle',
                            'curve-style': 'bezier',
                            'arrow-scale': 1.5
                        }
                    }
                ],
                layout: {
                    name: 'breadthfirst', // Use 'breadthfirst' layout
                    directed: true, // Direct the layout from parent to child
                    padding: 10, // Padding around the graph
                    spacingFactor: 1.5, // Spacing between nodes
                    animate: true,
                    fit: true // Fit the graph within the container
                },
                userZoomingEnabled: false, // Disable zooming
                userPanningEnabled: true, // Enable panning
                boxSelectionEnabled: true,
                autounselectify: true
            });

            // Initialize Cytoscape for Reference Tree
            let referenceCy = cytoscape({
                container: document.getElementById('referenceCy'),
                style: [
                    {
                        selector: 'node',
                        style: {
                            'content': 'data(label)',
                            'text-valign': 'center',
                            'color': '#fff',
                            'background-color': '#28a745',
                            'width': '50px',
                            'height': '50px',
                            'font-size': '14px',
                            'border-width': 2,
                            'border-color': '#fff'
                        }
                    },
                    {
                        selector: 'edge',
                        style: {
                            'width': 3,
                            'line-color': '#ccc',
                            'target-arrow-color': '#ccc',
                            'target-arrow-shape': 'triangle',
                            'curve-style': 'bezier',
                            'arrow-scale': 1.5
                        }
                    }
                ],
                layout: {
                    name: 'breadthfirst', // Use 'breadthfirst' layout
                    directed: true, // Direct the layout from parent to child
                    padding: 10, // Padding around the graph
                    spacingFactor: 1.5, // Spacing between nodes
                    animate: true,
                    fit: true // Fit the graph within the container
                },
                userZoomingEnabled: false, // Disable zooming
                userPanningEnabled: true, // Enable panning
                boxSelectionEnabled: true,
                autounselectify: true
            });

            // Function to highlight a node
            function highlightNode(key, treeType = 'player') {
                const nodeId = `n${key}`;
                let node;
                if (treeType === 'player') {
                    node = cy.getElementById(nodeId);
                } else if (treeType === 'reference') {
                    node = referenceCy.getElementById(nodeId);
                }
                if (node && node.length > 0) {
                    node.addClass('highlight');
                    setTimeout(() => {
                        node.removeClass('highlight');
                    }, 1000); // Highlight for 1 second
                }
            }

            // Update Score Function
            function updateScore(points) {
                currentScore = Math.max(0, currentScore + points);
                document.getElementById('score').innerText = `Score: ${currentScore}`;
            }

            // Stable unique id per browser (so multiple users with same name don't overwrite each other)
            function getPlayerId() {
                let id = localStorage.getItem('splayer_playerId');
                if (!id) {
                    id = 'p_' + Date.now() + '_' + Math.random().toString(36).slice(2, 12);
                    localStorage.setItem('splayer_playerId', id);
                }
                return id;
            }

            // Function to submit score to Firestore
            function submitScore() {
                const currentUsername = document.getElementById('username').value.trim();
                if (currentUsername === '') {
                    alert('Please enter your name to submit your score.');
                    return;
                }
                console.log(`Submitting score: ${currentScore}`);

                const playerId = getPlayerId();
                db.collection('leaderboard').doc(playerId).set({
                    username: currentUsername,
                    score: firebase.firestore.FieldValue.increment(currentScore),
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true })
                    .then(() => {
                        console.log('Score successfully submitted!');
                        loadLeaderboardRealtime(); // After submission, re-load leaderboard data
                    })
                    .catch((error) => {
                        console.error('Error submitting score: ', error);
                    });
            }

            // Render/Refresh Player's Cytoscape
            function refreshPlayerCytoscape() {
                console.log('Refreshing Player\'s Tree');
                cy.elements().remove();
                let elements = splayTree.getCytoscapeElements();
                console.log('Player elements:', elements);
                cy.add(elements);
                cy.layout({
                    name: 'breadthfirst',
                    directed: true,
                    padding: 10,
                    spacingFactor: 1.5,
                    animate: true,
                    fit: true
                }).run();
                checkMatch();
            }

            // Render/Refresh Reference Cytoscape
            function refreshReferenceCytoscape() {
                console.log('Refreshing Reference Tree');
                referenceCy.elements().remove();
                let elements = referenceTree.getCytoscapeElements();
                console.log('Reference elements:', elements);
                referenceCy.add(elements);
                referenceCy.layout({
                    name: 'breadthfirst',
                    directed: true,
                    padding: 10,
                    spacingFactor: 1.5,
                    animate: true,
                    fit: true
                }).run();
            }

            // Load Reference Tree for Current Level
            function loadReferenceTree(level) {
                console.log(`Loading Reference Tree for level ${level + 1}`);
                referenceTree = new SplayTree();
                let keys = levels[level];
                keys.forEach(key => {
                    console.log(`Inserting ${key} into Reference Tree`);
                    referenceTree.insert(key);
                });
                refreshReferenceCytoscape();
            }

            // Load Level
            function loadLevel(level) {
                console.log(`Loading Level ${level + 1}`);
                // Reset Player's Tree
                splayTree = new SplayTree();
                refreshPlayerCytoscape();
                // Load Reference Tree
                loadReferenceTree(level);
                // Reset Feedback
                document.getElementById('feedback').innerText = '';
                // Reset Score
                currentScore = 0;
                document.getElementById('score').innerText = `Score: ${currentScore}`;
                // Disable Next Level button until level is completed
                document.getElementById('nextLevelBtn').disabled = true;
                // Enable other buttons
                document.getElementById('insertBtn').disabled = false;
                document.getElementById('searchBtn').disabled = false;
                document.getElementById('deleteBtn').disabled = false;
            }

            // Compare Player's Tree with Reference Tree
            function treesMatch(playerRoot, referenceRoot) {
                if (playerRoot === null && referenceRoot === null) return true;
                if (playerRoot === null || referenceRoot === null) return false;
                if (playerRoot.key !== referenceRoot.key) return false;
                return treesMatch(playerRoot.left, referenceRoot.left) && treesMatch(playerRoot.right, referenceRoot.right);
            }

            // Check if Trees Match and Provide Feedback
            function checkMatch() {
                console.log('Checking if trees match.');
                if (treesMatch(splayTree.root, referenceTree.root)) {
                    console.log('Trees match.');
                    document.getElementById('feedback').innerText = 'ðŸŽ‰ Congratulations! Trees Match!';
                    document.getElementById('feedback').style.color = '#28a745';
                    updateScore(50); // +50 points for level completion
                    submitScore(); // Submit the score to Firestore
                    document.getElementById('nextLevelBtn').disabled = false; // Enable Next Level button
                    // Optionally disable other buttons to prevent further actions
                    document.getElementById('insertBtn').disabled = true;
                    document.getElementById('searchBtn').disabled = true;
                    document.getElementById('deleteBtn').disabled = true;
                } else {
                    console.log('Trees do not match.');
                    document.getElementById('feedback').innerText = 'Keep trying to match the reference tree.';
                    document.getElementById('feedback').style.color = '#dc3545';
                    document.getElementById('nextLevelBtn').disabled = true; // Disable Next Level button
                }
            }

            // Function to load the leaderboard in real-time (only on pages that have #leaderboard, e.g. leaderboard.html)
            function loadLeaderboardRealtime() {
                const leaderboardEl = document.getElementById('leaderboard');
                if (!leaderboardEl) return;
                const leaderboardBody = leaderboardEl.getElementsByTagName('tbody')[0];
                if (!leaderboardBody) return;
                console.log('Setting up real-time leaderboard listener...');

                // Set up real-time listener
                const unsubscribe = db.collection('leaderboard')
                    .orderBy('score', 'desc')
                    .orderBy('lastUpdated', 'asc')
                    .limit(10)
                    .onSnapshot((querySnapshot) => {
                        leaderboardBody.innerHTML = '';
                        let rank = 1;

                        if (querySnapshot.empty) {
                            console.log('No leaderboard data found.');
                            const row = leaderboardBody.insertRow();
                            const cell = row.insertCell(0);
                            cell.colSpan = 4;
                            cell.innerText = 'No data available.';
                            cell.style.color = '#dc3545';
                            return;
                        }

                        querySnapshot.forEach((doc) => {
                            const data = doc.data();
                            console.log('Leaderboard doc:', doc.id, data);

                            const date = data.lastUpdated
                                ? data.lastUpdated.toDate().toLocaleString()
                                : 'N/A';
                            const row = leaderboardBody.insertRow();
                            row.insertCell(0).innerText = rank;
                            row.insertCell(1).innerText = data.username;
                            row.insertCell(2).innerText = data.score;
                            row.insertCell(3).innerText = date;
                            rank++;
                        });
                        console.log('Leaderboard updated with', querySnapshot.size, 'entries.');
                    }, (error) => {
                        console.error('Error fetching leaderboard: ', error);
                    });
            }

            // Button Handlers
            document.getElementById('insertBtn').addEventListener('click', () => {
                const raw = document.getElementById('nodeValue').value.trim();
                const isInteger = /^-?\d+$/.test(raw);
                const value = isInteger ? parseInt(raw, 10) : NaN;
                if (!isNaN(value)) {
                    console.log(`Inserting ${value} into Player Tree`);
                    const inserted = splayTree.insert(value);
                    refreshPlayerCytoscape();
                    highlightNode(value, 'player'); // Highlight the inserted node in player's tree
                    if (inserted) {
                        updateScore(10); // +10 points for insertion
                    } else {
                        updateScore(-5); // -5 points for duplicate insertion
                        alert('Key already exists in the tree.');
                    }
                } else {
                    // Handle incorrect input
                    updateScore(-5); // -5 points for incorrect input
                    alert('Please enter a valid number.');
                }
            });

            document.getElementById('searchBtn').addEventListener('click', () => {
                const raw = document.getElementById('nodeValue').value.trim();
                const isInteger = /^-?\d+$/.test(raw);
                const value = isInteger ? parseInt(raw, 10) : NaN;
                if (!isNaN(value)) {
                    console.log(`Searching for ${value} in Player Tree`);
                    const result = splayTree.search(value);
                    refreshPlayerCytoscape();
                    highlightNode(value, 'player'); // Highlight the searched node in player's tree
                    if (result) {
                        updateScore(5); // +5 points for successful search
                    } else {
                        updateScore(-5); // -5 points for unsuccessful search
                        alert('Key not found in the tree.');
                    }
                } else {
                    // Handle incorrect input
                    updateScore(-5); // -5 points for incorrect input
                    alert('Please enter a valid number.');
                }
            });

            document.getElementById('deleteBtn').addEventListener('click', () => {
                const raw = document.getElementById('nodeValue').value.trim();
                const isInteger = /^-?\d+$/.test(raw);
                const value = isInteger ? parseInt(raw, 10) : NaN;
                if (!isNaN(value)) {
                    console.log(`Deleting ${value} from Player Tree`);
                    const result = splayTree.delete(value);
                    refreshPlayerCytoscape();
                    if (result) {
                        updateScore(15); // +15 points for successful deletion
                    } else {
                        updateScore(-5); // -5 points for unsuccessful deletion
                        alert('Key not found in the tree. Cannot delete.');
                    }
                } else {
                    // Handle incorrect input
                    updateScore(-5); // -5 points for incorrect input
                    alert('Please enter a valid number.');
                }
            });

            document.getElementById('resetBtn').addEventListener('click', () => {
                console.log('Resetting Player Tree');
                splayTree = new SplayTree();
                refreshPlayerCytoscape();
                // Optionally, reset score
                currentScore = 0;
                document.getElementById('score').innerText = `Score: ${currentScore}`;
                // Disable Next Level button
                document.getElementById('nextLevelBtn').disabled = true;
                // Enable buttons
                document.getElementById('insertBtn').disabled = false;
                document.getElementById('searchBtn').disabled = false;
                document.getElementById('deleteBtn').disabled = false;
            });

            document.getElementById('nextLevelBtn').addEventListener('click', () => {
                currentLevel++;
                if (currentLevel >= levels.length) {
                    alert('You have completed all levels!');
                    currentLevel = levels.length - 1; // Stay at last level
                    return;
                }
                loadLevel(currentLevel);
            });

            // Initialize Game
            loadLevel(currentLevel);
        });
    </script>
</body>

</html>